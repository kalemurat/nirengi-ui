<div [class]="'nui-select ' + containerClasses()">
  <!-- Label -->
  @if (label()) {
    <label [for]="inputId" class="nui-select__label">
      {{ label() }}
    </label>
  }

  <div class="nui-select__container" #container>
    <!-- Trigger Button -->
    <div
      [class]="'nui-select__trigger ' + triggerClasses()"
      cdkOverlayOrigin
      #trigger="cdkOverlayOrigin"
      [class.nui-select__trigger--disabled]="isDisabled()"
      [class.nui-select__trigger--success]="success()"
      [class.nui-select__trigger--warning]="warning()"
      [class.nui-select__trigger--open]="isOpen()"
      (click)="toggleDropdown()"
      tabindex="0"
      (keydown.enter)="toggleDropdown()"
      (keydown.space)="toggleDropdown()"
    >
      <!-- Value Display -->
      <div class="nui-select__value" [class.nui-select__value--placeholder]="!hasValue()">
        @if (multiple() && hasValue()) {
          <div class="nui-select__chips">
            @for (item of selectedItems(); track $index) {
              <span class="nui-select__chip">
                {{ getLabel(item) }}
                <span class="nui-select__chip-remove" (click)="removeItem(item, $event)">
                  <nui-icon name="X" [size]="12" />
                </span>
              </span>
            }
          </div>
        } @else if (!multiple() && hasValue()) {
          {{ getLabel(selectedItems()[0]) }}
        } @else {
          {{ placeholder() }}
        }
      </div>

      <!-- Clear Button -->
      @if (hasValue() && clearable() && !isDisabled()) {
        <button type="button" class="nui-select__clear" (click)="clearValue($event)" aria-label="Clear selection">
          <nui-icon name="X" [size]="iconSize()" />
        </button>
      }

      <!-- Arrow Icon -->
      <div class="nui-select__icon" [class.nui-select__icon--open]="isOpen()">
        <nui-icon name="ChevronDown" [size]="iconSize()" />
      </div>
    </div>

    <!-- Dropdown Template -->
    <ng-template #dropdownContent>
      <div class="nui-select__dropdown" [class.nui-select__dropdown--overlay]="appendToBody()">
        <!-- Search Input -->
        @if (searchable()) {
          <div class="nui-select__search">
            <input
              #searchInput
              type="text"
              class="nui-select__search-input"
              [placeholder]="'Search...'"
              (input)="onSearch($event)"
              (click)="$event.stopPropagation()"
            />
          </div>
        }

        <!-- Options List -->
        <div class="nui-select__options">
          @for (option of filteredOptions(); track trackByFn($index, option)) {
            <div
              class="nui-select__option"
              [class.nui-select__option--selected]="isSelected(option)"
              (click)="selectOption(option)"
            >
              <!-- Content -->
              <ng-container
                [ngTemplateOutlet]="itemTemplate() || defaultItemTemplate"
                [ngTemplateOutletContext]="{ $implicit: option, selected: isSelected(option) }"
              ></ng-container>

              <!-- Checkmark for multiple (or single) -->
              @if (isSelected(option)) {
                <span class="nui-select__option-check">
                  <nui-icon name="Check" [size]="16" />
                </span>
              }
            </div>
          } @empty {
            <div class="nui-select__empty">No results found.</div>
          }
        </div>
      </div>
    </ng-template>

    <!-- Overlay Mode -->
    @if (appendToBody() && isOpen() && !isDisabled()) {
      <ng-template
        cdkConnectedOverlay
        [cdkConnectedOverlayOrigin]="trigger"
        [cdkConnectedOverlayOpen]="isOpen()"
        [cdkConnectedOverlayWidth]="triggerWidth() || '100%'"
        [cdkConnectedOverlayPanelClass]="overlayPanelClasses()"
        (backdropClick)="close()"
        [cdkConnectedOverlayHasBackdrop]="true"
        [cdkConnectedOverlayBackdropClass]="'cdk-overlay-transparent-backdrop'"
      >
        <ng-container [ngTemplateOutlet]="dropdownContent"></ng-container>
      </ng-template>
    }

    <!-- Inline Mode -->
    @if (!appendToBody() && isOpen() && !isDisabled()) {
      <ng-container [ngTemplateOutlet]="dropdownContent"></ng-container>
    }
  </div>

  <!-- Hint & Status Messages -->
  @if (success()) {
    <p class="nui-select__success">{{ success() }}</p>
  } @else if (warning()) {
    <p class="nui-select__warning">{{ warning() }}</p>
  } @else if (hint()) {
    <p class="nui-select__hint">{{ hint() }}</p>
  }

  <!-- Default Item Template -->
  <ng-template #defaultItemTemplate let-option>
    {{ getLabel(option) }}
  </ng-template>
</div>
